<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>安全书签树 (WASM + Ephemeral)</title>
<style>
body{font-family: Arial, sans-serif; padding:20px; background:#f5f6f9; color:#333;}
.container{max-width:1000px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.08);}
.toolbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;}
.toolbar .right{display:flex; gap:8px; align-items:center;}
.btn{padding:6px 10px; border-radius:6px; border:none; cursor:pointer; background:#e9eef7;}
.btn-primary{background:#06f; color:#fff;}
input, select{padding:6px 8px; border:1px solid #ddd; border-radius:6px;}
.tree{list-style:none; padding-left:12px; margin:0;}
.tree li{position:relative; margin:3px 0;}
.tree li .node-header{display:flex; justify-content:space-between; align-items:center;padding:4px 6px; border-radius:6px;}
.tree li .node-header:hover{ background:#f2f6ff; }
.tree li .node-label{ display:flex; align-items:center; gap:6px; min-width:0; }
.tree li .node-label .icon{ width:1.2em; text-align:center; flex:0 0 auto; }
.tree li .name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.tree li ul{ display:none; padding-left:18px; margin:0; }
.tree li.open > ul{ display:block; }
.node-actions{ flex:0 0 auto; display:flex; gap:6px; }
.node-actions .btn{ padding:2px 6px; }
.selected{ background:#cfe4ff !important; }
.tag{ font-size:12px; padding:2px 6px; border-radius:999px; background:#eef3ff; color:#356; margin-left:6px; }
.drag-over{ outline:2px dashed #06f; outline-offset:2px; }
:root{--bg-color:#ffffff;--text-color:#000000;}
body{background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease;}
.theme-picker{margin: 1rem;}
</style>
</head>
<body>
<div class="container">
  <div class="toolbar">
    <h2>🔒 安全书签树 (WASM + Ephemeral)</h2>
    <div class="theme-picker">
      <label>选择主题颜色: </label>
      <input type="color" id="bgPicker" value="#ffffff" />
      <input type="color" id="textPicker" value="#000000" />
    </div>
    <div class="right">
      <input id="searchInput" placeholder="搜索名称或标签..." />
	   <button id="exportBtn">导出数据</button>
	  <input type="file" id="importFile" />
	  <button id="importBtn">导入数据</button>
      <pre id="preview"></pre>
      <button id="clearSearchBtn" class="btn">清空搜索</button>
      <button id="editorBtn" class="btn">进入编辑模式</button>
      <button id="importBtn" class="btn">批量导入</button>
    </div>
  </div>

  <div id="editorPanel" style="display:none; margin-bottom:10px;">
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
      <select id="typeIn">
        <option value="file">文件</option>
        <option value="folder">文件夹</option>
      </select>
      <input id="titleIn" placeholder="名称" />
      <input id="urlIn" placeholder="URL（仅文件用）" />
      <input id="tagIn" placeholder="标签（可选）" />
      <select id="parentIn"></select>
      <button id="addBtn" class="btn btn-primary">添加</button>
    </div>
  </div>

  <ul class="tree" id="bookmarkTree"></ul>
</div>

<script type="module">
import init, {
  use_embedded_key, set_password, verify_editor,
  load_cipher_and_get_censored, get_censored_json,
  get_and_refresh_eph_map, get_current_eph_map, open_by_eph,
  add_node, edit_node, delete_node, move_node, export_encrypted,
  init_sample_if_empty
} from './pkg/wasm_crypto.js';

const STORAGE_KEY = "bookmarks_cipher_wasm_ephem_v1";
let isEditor = false, censored = [], ephMap = {}, filterKeyword = '';

async function boot(){
  await init(); use_embedded_key();
  const cipher = localStorage.getItem(STORAGE_KEY);
  if(cipher){
    try{ censored = JSON.parse(await load_cipher_and_get_censored(cipher)); }
    catch{ init_sample_if_empty(); censored = JSON.parse(await get_censored_json()); }
  } else { init_sample_if_empty(); censored = JSON.parse(await get_censored_json()); }
  ephMap = JSON.parse(await get_and_refresh_eph_map());
  renderTree(); bindUI(); updateParentOptions();
}

function buildHierarchy(list, kw=''){
  const byId = new Map(list.map(n=>[n.id, {...n, children:[]}]));
  const roots = [];
  for(const n of byId.values()){ n.parent && byId.has(n.parent) ? byId.get(n.parent).children.push(n) : roots.push(n); }
  if(!kw) return roots;
  const k = kw.toLowerCase();
  function prune(n){ const selfMatch = n.title.toLowerCase().includes(k) || (n.tag && n.tag.toLowerCase().includes(k)); const kids = (n.children||[]).map(prune).filter(Boolean); return (selfMatch || kids.length) ? {...n, children:kids} : null; }
  return roots.map(prune).filter(Boolean);
}

function renderTree(){
  const tree = document.getElementById('bookmarkTree'); tree.innerHTML='';
  const roots = buildHierarchy(censored, filterKeyword);
  function renderNode(n){
    const li = document.createElement('li'); li.className = n.node_type;
    const header = document.createElement('div'); header.className='node-header';
    const label = document.createElement('div'); label.className='node-label';
    const icon = document.createElement('span'); icon.className='icon'; icon.textContent = n.node_type==='folder'?'📁':'📄';
    const name = document.createElement('span'); name.className='name'; name.textContent=n.title;
    label.appendChild(icon); label.appendChild(name);
    if(n.tag){ const t=document.createElement('span'); t.className='tag'; t.textContent=n.tag; label.appendChild(t);}
    header.appendChild(label);

    if(isEditor){
      const actions = document.createElement('div'); actions.className='node-actions';
      if(n.node_type==='folder'){
        const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='添加子项';
        addBtn.onclick=async e=>{
          e.stopPropagation();
          const tp = (prompt('类型 file/folder','file')||'file').toLowerCase()==='folder'?'folder':'file';
          const title = prompt('名称',''); if(!title) return;
          let url=null,tag=null; if(tp==='file'){ url=prompt('URL','')||''; } tag=prompt('标签','')||'';
          await add_node(JSON.stringify({id:'', node_type:tp, title, url, tag, parent:n.id}));
          const b64 = await export_encrypted(); localStorage.setItem(STORAGE_KEY,b64);
          censored=JSON.parse(await get_censored_json()); ephMap=JSON.parse(await get_and_refresh_eph_map());
          renderTree(); updateParentOptions();
        }; actions.appendChild(addBtn);
      }

      const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='编辑';
      editBtn.onclick=async e=>{
        e.stopPropagation();
        const nt=prompt('名称：',n.title)||n.title; let nu=null;
        if(n.node_type==='file'){ nu=prompt('URL','')||''; }
        const tg=prompt('标签：',n.tag||'')||n.tag||'';
        await edit_node(n.id, nt, nu, tg, n.parent||null);
        const b64=await export_encrypted(); localStorage.setItem(STORAGE_KEY,b64);
        censored=JSON.parse(await get_censored_json()); ephMap=JSON.parse(await get_and_refresh_eph_map());
        renderTree(); updateParentOptions();
      };

      const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='删除';
      delBtn.onclick=async e=>{
        e.stopPropagation(); if(!confirm('确定删除（文件夹将递归删除）？')) return;
        await delete_node(n.id);
        const b64=await export_encrypted(); localStorage.setItem(STORAGE_KEY,b64);
        censored=JSON.parse(await get_censored_json()); ephMap=JSON.parse(await get_and_refresh_eph_map());
        renderTree(); updateParentOptions();
      };

      const moveBtn=document.createElement('button'); moveBtn.className='btn'; moveBtn.textContent='移动到...';
      moveBtn.onclick=async e=>{
        e.stopPropagation();
        const pid=prompt('输入目标父级ID（留空=根）',n.parent||'');
        await move_node(n.id,pid||null);
        const b64=await export_encrypted(); localStorage.setItem(STORAGE_KEY,b64);
        censored=JSON.parse(await get_censored_json()); ephMap=JSON.parse(await get_and_refresh_eph_map());
        renderTree(); updateParentOptions();
      };

      actions.appendChild(editBtn); actions.appendChild(moveBtn); actions.appendChild(delBtn);
      header.appendChild(actions);
    }

    header.onclick=async e=>{
      e.stopPropagation();
      if(n.node_type==='folder'){
        li.classList.toggle('open');
      }else{
        const eph = ephMap[n.id];
        if(!eph){ alert('临时ID不存在或已过期，请刷新。'); return; }
        try{ await open_by_eph(eph); ephMap=JSON.parse(await get_and_refresh_eph_map()); }catch(err){ alert('打开失败：'+err); }
      }
    };
    li.appendChild(header);

    if(n.children && n.children.length){
      const ul=document.createElement('ul');
      n.children.forEach(c=>ul.appendChild(renderNode(c)));
      li.appendChild(ul);
    }
    return li;
  }
  roots.forEach(r=>tree.appendChild(renderNode(r)));
}

function updateParentOptions(){
  const sel=document.getElementById('parentIn'); sel.innerHTML=`<option value="">根目录</option>`;
  censored.filter(n=>n.node_type==='folder').forEach(f=>{
    sel.innerHTML+=`<option value="${f.id}">${f.title} (${f.id})</option>`;
  });
}

function bindUI(){
  const editorBtn=document.getElementById('editorBtn'); const editorPanel=document.getElementById('editorPanel');
  editorBtn.onclick=async ()=>{
    if(!isEditor){
      const pass=prompt('请输入编辑者口令'); if(!pass) return;
      if(!verify_editor(pass)){ alert('口令错误'); return; }
      isEditor=true; editorPanel.style.display='block'; editorBtn.textContent='退出编辑模式';
      ephMap=JSON.parse(await get_and_refresh_eph_map()); renderTree();
    }else{
      isEditor=false; editorPanel.style.display='none'; editorBtn.textContent='进入编辑模式'; renderTree();
    }
  };

  document.getElementById('addBtn').onclick=async ()=>{
    if(!isEditor){ alert('请先进入编辑模式'); return; }
    const tp=document.getElementById('typeIn').value;
    const t=document.getElementById('titleIn').value.trim();
    const u=document.getElementById('urlIn').value.trim();
    const tg=document.getElementById('tagIn').value.trim();
    const p=document.getElementById('parentIn').value||null;
    if(!t){ alert('名称必填'); return; }
    if(tp==='file' && !u){ alert('URL 仅在添加文件时必填'); return; }

    await add_node(JSON.stringify({id:'', node_type:tp, title:t, url:tp==='file'?u:null, tag:tg||null, parent:p}));
    const b64=await export_encrypted(); localStorage.setItem(STORAGE_KEY,b64);
    censored=JSON.parse(await get_censored_json()); ephMap=JSON.parse(await get_and_refresh_eph_map());

    document.getElementById('titleIn').value=''; document.getElementById('urlIn').value=''; document.getElementById('tagIn').value=''; document.getElementById('typeIn').value='file'; document.getElementById('parentIn').value='';
    renderTree(); updateParentOptions();
  };

  const search=document.getElementById('searchInput'); search.addEventListener('input',()=>{ filterKeyword=search.value.trim(); renderTree(); });
  document.getElementById('clearSearchBtn').onclick=()=>{ filterKeyword=''; search.value=''; renderTree(); };

  // 批量导入
  document.getElementById('importBtn').onclick=async ()=>{
    if(!isEditor){ alert('请先进入编辑模式'); return; }
    const input=document.createElement('input'); input.type='file'; input.accept='.json';
    input.onchange=async e=>{
      const file=e.target.files[0]; if(!file) return;
      const text=await file.text(); let list=[];
      try{ list=JSON.parse(text); } catch{ alert('JSON 格式错误'); return; }
      let addedCount=0;
      for(const it of list){
        if(!it.title) continue;
        const nodeData={id:'', node_type:it.node_type||'file', title:it.title, url:it.url||null, tag:it.tag||null, parent:it.parent||null};
        try{ await add_node(JSON.stringify(nodeData)); addedCount++; }catch(err){ console.warn('导入失败',nodeData,err); }
      }
      if(addedCount>0){
        const b64=await export_encrypted(); localStorage.setItem(STORAGE_KEY,b64);
        censored=JSON.parse(await get_censored_json()); ephMap=JSON.parse(await get_and_refresh_eph_map());
        renderTree(); updateParentOptions(); alert(`导入完成，共导入 ${addedCount} 条有效书签`);
      }else{ alert('没有有效书签可导入'); }
    }; input.click();
  };
}

// 主题控制
function applyTheme(theme){ document.documentElement.style.setProperty("--bg-color",theme.bg); document.documentElement.style.setProperty("--text-color",theme.text); }
const savedTheme=JSON.parse(localStorage.getItem("userTheme")); if(savedTheme) applyTheme(savedTheme);
document.getElementById("bgPicker").addEventListener("input",e=>{ const theme={bg:e.target.value, text:document.getElementById("textPicker").value}; applyTheme(theme); localStorage.setItem("userTheme",JSON.stringify(theme)); });
document.getElementById("textPicker").addEventListener("input",e=>{ const theme={bg:document.getElementById("bgPicker").value, text:e.target.value}; applyTheme(theme); localStorage.setItem("userTheme",JSON.stringify(theme)); });
async function loadDefaultData(){
  const res = await fetch('/localStorage-data (1).json');
  const cipher = await res.text();
  localStorage.setItem(STORAGE_KEY, cipher);  // 可选，保存到本地
  censored = JSON.parse(await load_cipher_and_get_censored(cipher));
  ephMap = JSON.parse(await get_and_refresh_eph_map());
  renderTree();
}
loadDefaultData
 //////

 
    // ✅ 导出 LocalStorage 数据为 JSON 文件
    document.getElementById("exportBtn").onclick = function () {
      const data = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        data[key] = localStorage.getItem(key);
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "localStorage-data.json";
      a.click();

      URL.revokeObjectURL(url);
    };

    // ✅ 导入 JSON 文件写入 LocalStorage
    document.getElementById("importBtn").onclick = function () {
      const fileInput = document.getElementById("importFile");
      if (!fileInput.files.length) {
        alert("请选择一个 JSON 文件！");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          for (const key in data) {
            localStorage.setItem(key, data[key]);
          }
          alert("导入成功！请刷新页面查看数据。");
          document.getElementById("preview").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          alert("导入失败：文件格式错误！");
        }
      };
      reader.readAsText(file);
    }; 
boot();
</script>
</body>
</html>

